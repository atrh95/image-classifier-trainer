name: ImageClassifierTrainer CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Mintのセットアップ
  setup-mint:
    name: Setup Mint
    uses: ./.github/workflows/setup-mint.yml
    permissions:
      contents: read

  # コード品質チェック
  code-quality:
    name: Code Quality Check
    needs: setup-mint
    uses: ./.github/workflows/code-quality.yml
    
  # ユニットテストを実行
  run-tests:
    name: Run Unit Tests
    needs: setup-mint
    uses: ./.github/workflows/run-tests.yml 

  # テスト結果レポート生成
  report:
    name: Report Status
    needs:
      - run-tests
    if: always()
    uses: ./.github/workflows/test-reporter.yml
    with:
      test_run_outcome: ${{ needs.run-tests.outputs.test_result }}

  # ビルド完了通知
  notify:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs:
      - report
    if: always()
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Determine Overall Status and Icon
        id: status_check
        run: |
          # Default to failure
          final_status="failure"
          final_icon="❌"
          final_message="CI Pipeline finished with failures."

          # Check if all critical preceding jobs succeeded
          if [[ "${{ needs.report.outputs.overall_test_result }}" == "success" ]]; then
            final_status="success"
            final_icon="✅"
            final_message="CI Pipeline Completed Successfully!"
          fi
          echo "status=$final_status" >> $GITHUB_OUTPUT
          echo "icon=$final_icon" >> $GITHUB_OUTPUT
          echo "message=$final_message" >> $GITHUB_OUTPUT

      - name: Add Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const test_status = '${{ needs.report.outputs.overall_test_result }}' === 'success' ? '✅' : ('${{ needs.report.outputs.overall_test_result }}' === 'skipped' ? '⏭️' : '❌');

            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `## CI Pipeline Completed ${{ steps.status_check.outputs.icon }}\n
              ${{ steps.status_check.outputs.message }}\n
              ### ステータス概要:\n
              -   Overall Test Status: ${test_status}
              `
            });
